# Database Migrations

This directory contains SQL migration scripts for the Supabase database.

## Quick Start: Complete Setup

**Run everything at once:**

1. **Create Storage Bucket** (via Dashboard):
   - Go to Supabase Dashboard → Storage
   - Click "New bucket"
   - Name: `moments`
   - ✅ Check "Public bucket"
   - Click "Create bucket"

2. **Run Complete Setup Script**:
   - Go to Supabase Dashboard → SQL Editor
   - Copy and paste contents of `complete-setup.sql`
   - Click **Run**

That's it! This single script sets up:
- ✅ Database schema (adds missing columns)
- ✅ Table RLS policies (profiles, moments, reactions, reports, blocks, device_tokens)
- ✅ Storage RLS policies (moments bucket)
- ✅ Feed moments view
- ✅ Indexes for performance

## Individual Scripts

If you prefer to run scripts individually:

### `complete-setup.sql` ⭐ **RECOMMENDED**
- **Run this first** - Complete setup with all policies
- Includes everything you need in one script

### `fix-schema.sql`
- Adds missing columns to tables
- Generated by `npm run db:inspect`
- Run if you only need schema fixes

### `storage-policies.sql`
- Storage RLS policies for moments bucket
- Run if you only need storage policies

### `expected-schema.sql`
- Complete expected database schema (reference)
- Useful for creating a fresh database
- Not a migration - use as reference

## Setup Checklist

- [ ] Create `moments` storage bucket (public)
- [ ] Run `complete-setup.sql` in SQL Editor
- [ ] Verify tables have columns (check Dashboard → Database → Tables)
- [ ] Verify storage bucket exists (check Dashboard → Storage)
- [ ] Test app - try uploading a moment
- [ ] Test app - verify feed loads

## Troubleshooting

### "Bucket not found"
- ✅ Create the bucket in Storage → New bucket
- ✅ Name must be exactly `moments` (case-sensitive)
- ✅ Must be set to "Public bucket"

### "Row-level security policy violation"
- ✅ Run `complete-setup.sql` to create all policies
- ✅ Verify user is authenticated
- ✅ Check policies exist in Dashboard → Database → Policies

### "Table missing columns"
- ✅ Run `complete-setup.sql` (includes schema fixes)
- ✅ Or run `fix-schema.sql` separately

## Verification

After running `complete-setup.sql`, verify:

```sql
-- Check tables exist and have columns
SELECT table_name, column_name 
FROM information_schema.columns 
WHERE table_schema = 'public' 
ORDER BY table_name, ordinal_position;

-- Check RLS is enabled
SELECT tablename, rowsecurity 
FROM pg_tables 
WHERE schemaname = 'public';

-- Check policies exist
SELECT schemaname, tablename, policyname 
FROM pg_policies 
WHERE schemaname = 'public';

-- Check storage policies
SELECT * FROM storage.policies WHERE bucket_id = 'moments';

-- Check view exists
SELECT * FROM information_schema.views 
WHERE table_schema = 'public' AND table_name = 'feed_moments';
```

## Related Documentation

- `docs/supabase-rls.md` - Detailed RLS policy documentation
- `docs/supabase-storage-setup.md` - Storage setup guide
- `docs/legacy-data-migration.md` - Migration guide for legacy data
